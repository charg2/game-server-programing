#pragma once
#include <cstdint>
#include <Windows.h>
#include <type_traits>
#include "MemoryPool_Stack.h"
//#include "ThreadLocalMemoryPool.h"

#define Out
// no TTAS no Backoff
// 어째선지.. 내머신(3700x)에선 이게 성능이더 잘나옴...
// 노트북에선 안나오는데;

// 내머신(3700x)에선 ttas backoff spin이 더 안나옴.


// back off spin 
using namespace c2::concurrency;
namespace c2::concurrency
{
	template<typename Type, size_t Reserve = 1024/* MemoryPool reserve */ >
	class ConcurrentStack
	{
		struct alignas(16) Node
		{
			Node*	next;
			Type	data;
		};

		struct alignas(16) TopNode
		{
			Node*		node;
			uint64_t	id;
		};

	public:
		ConcurrentStack() : top{ nullptr, 1984 }, element_count{}
		{}

		~ConcurrentStack()
		{}

		void push(Type data)
		{
			BackOff backoff{ BackOff::min_delay };

			//Node* new_node = new Node();
			Node* new_node = node_pool.alloc();
			new_node->data = data;

			TopNode local_top{ this->top.node, this->top.id };

			for (;;)
			{
				if (this->top.id != local_top.id)
				{
					local_top.node = this->top.node;
					local_top.id = this->top.id;			// 사실 이거만 갱신해줘도 됨 일단은 ;; 

					continue;
				}
				else // 같으면 
				{
					new_node->next = local_top.node;

					if (0 == InterlockedCompareExchange128((int64_t*)&this->top, (int64_t)(this->top.id + 1), (int64_t)new_node, (int64_t*)&local_top))
					{
						backoff.do_backoff();
						
						continue;
					}
					else
					{
						return;
					}
				}
			}
		}

		bool try_push(Type& new_node)
		{
			TopNode local_top{ this->top.node, this->top.id };

			return InterlockedCompareExchange128((int64_t*)&this->top, (int64_t)(this->top.id + 1), (int64_t)new_node, (int64_t*)&local_top);
		}

		bool try_pop(Out Type& dest)
		{
			BackOff backoff{ BackOff::min_delay };
			TopNode local_top{ this->top.node, this->top.id };

			for (;;)
			{
				if (nullptr == local_top.node)
				{
					return false;
				}

				if (this->top.id != local_top.id)
				{
					local_top.node = this->top.node;
					local_top.id = this->top.id;

					continue;
				}
				else
				{
					if (0 == InterlockedCompareExchange128((int64_t*)&this->top, (int64_t)(local_top.id + 1), (int64_t)local_top.node->next, (int64_t*)&local_top))
					{
						backoff.do_backoff();

						continue;
					}
					else
					{
						dest = local_top.node->data;

						//delete local_top.node;
						node_pool.free(local_top.node);

						return true;
					}
				}

			}
		}

		size_t unsfae_size()
		{
			return element_count;
		}

	private:
		TopNode									top;
		size_t									element_count;
		ConcurrentStackMemoryPool<Node, Reserve, false>	node_pool;
		//ThreadLocalMemoryPool<Node, Reserve, false>	node_pool;
		//char	cache_line[64 - sizeof(TopNode) - sizeof(size_t)];
	};
}


// x64 release no - optimaizaion  16thread ( 8 base concurent_stack + 8 concurrent_stack + back off )
/* TTAS Backoff Lock

TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

12068  simulate_concurrent_stack                                                                 1         365854.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

21168  simulate_concurrent_stack                                                                 1         366369.1000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

2340   simulate_concurrent_stack                                                                 1         368508.5000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

7908   simulate_concurrent_stack                                                                 1         372341.0000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

14628  simulate_concurrent_stack                                                                 1         372863.0000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

21604  simulate_concurrent_stack                                                                 1         373910.9000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

908    simulate_concurrent_stack                                                                 1         374851.7000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

6092   simulate_concurrent_stack                                                                 1         376174.0000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

5472   simulate_concurrent_stack_using_back_off                                                  1         392192.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

10548  simulate_concurrent_stack_using_back_off                                                  1         400391.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

28648  simulate_concurrent_stack_using_back_off                                                  1         413056.8000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

27996  simulate_concurrent_stack_using_back_off                                                  1         413905.8000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

12608  simulate_concurrent_stack_using_back_off                                                  1         415471.0000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

29744  simulate_concurrent_stack_using_back_off                                                  1         416316.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

11032  simulate_concurrent_stack_using_back_off                                                  1         418079.5000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

5592   simulate_concurrent_stack_using_back_off                                                  1         418371.1000㎲
========================================================================================================================

8000000
8000000

*/


/* BackOff 


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

4356   simulate_concurrent_stack                                                                 1         338952.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

20908  simulate_concurrent_stack                                                                 1         353287.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

28204  simulate_concurrent_stack                                                                 1         358011.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

26516  simulate_concurrent_stack                                                                 1         360183.2000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

20716  simulate_concurrent_stack                                                                 1         361586.9000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

7776   simulate_concurrent_stack                                                                 1         362201.0000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

14440  simulate_concurrent_stack                                                                 1         363617.2000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

23088  simulate_concurrent_stack                                                                 1         370328.9000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

22580  simulate_concurrent_stack_using_back_off                                                  1         683811.2000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

21396  simulate_concurrent_stack_using_back_off                                                  1         715122.8000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

24432  simulate_concurrent_stack_using_back_off                                                  1         733308.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

25248  simulate_concurrent_stack_using_back_off                                                  1         760892.5000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

10388  simulate_concurrent_stack_using_back_off                                                  1         770960.8000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

24404  simulate_concurrent_stack_using_back_off                                                  1         771940.9000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

15008  simulate_concurrent_stack_using_back_off                                                  1         772481.5000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

17720  simulate_concurrent_stack_using_back_off                                                  1         783542.5000㎲
========================================================================================================================

8000000
8000000

*/

////////////////
/*

TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

26512  simulate_concurrent_stack                                                                 1         598682.2000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

29396  simulate_concurrent_stack                                                                 1         607249.1000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

7976   simulate_concurrent_stack                                                                 1         616833.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

8588   simulate_concurrent_stack                                                                 1         620431.5000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

27528  simulate_concurrent_stack                                                                 1         622070.7000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

25592  simulate_concurrent_stack                                                                 1         625214.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

29736  simulate_concurrent_stack                                                                 1         628717.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

4680   simulate_concurrent_stack                                                                 1         630631.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

20176  simulate_concurrent_stack                                                                 1         633363.6000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

1768   simulate_concurrent_stack                                                                 1         636897.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

26812  simulate_concurrent_stack                                                                 1         638421.4000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

28968  simulate_concurrent_stack                                                                 1         639375.7000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

13904  simulate_concurrent_stack                                                                 1         640542.3000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

8960   simulate_concurrent_stack                                                                 1         642172.3000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

27200  simulate_concurrent_stack                                                                 1         652170.9000㎲
========================================================================================================================


TID    Func                                                                                      Call      Average(㎲)
========================================================================================================================

20368  simulate_concurrent_stack                                                                 1         652434.7000㎲
========================================================================================================================

16000000
0

*/


